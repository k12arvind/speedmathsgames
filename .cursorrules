# CLAT GK Preparation System - Cursor AI Rules

## Project Overview
This is a CLAT (Common Law Admission Test) exam preparation system that:
- Processes daily and weekly current affairs PDFs
- Generates Anki flashcards using Claude AI (Anthropic API)
- Provides web-based dashboard for PDF management
- Handles large PDFs through intelligent chunking
- Runs on two machines: MacBook Pro (dev) and Mac Mini (production)

## Tech Stack
- **Backend:** Python 3.9, Flask (port 8001)
- **AI:** Anthropic Claude API (Sonnet 4.5)
- **Database:** SQLite (revision_tracker.db, assessment_tracker.db)
- **Frontend:** HTML/CSS/JavaScript, Bootstrap 5
- **PDF Processing:** PyMuPDF (fitz), ReportLab
- **Flashcards:** Anki with AnkiConnect

## Critical File Structure

### PDFs Storage (NEVER modify these locations)
```
~/saanvi/
├── Legaledgedailygk/        # Daily current affairs PDFs
├── LegalEdgeweeklyGK/       # Weekly PDFs (LegalEdge)
└── weeklyGKCareerLauncher/  # Weekly PDFs (Career Launcher)
```

### Project Structure
```
~/clat_preparation/
├── server/                   # Backend Python modules
│   ├── unified_server.py    # Main Flask API server
│   ├── pdf_chunker.py       # PDF splitting (>20 pages → 8-10 page chunks)
│   ├── assessment_processor.py  # Background flashcard generation
│   ├── pdf_scanner.py       # PDF folder scanner
│   └── assessment_jobs_db.py    # Job tracking
├── dashboard/               # Frontend HTML/JS pages
├── toprankers/             # TopRankers automation scripts
│   ├── automate_html.sh    # Main automation script
│   ├── extract_html.py     # HTML extraction
│   └── generate_clean_pdf_final.py  # PDF generation
├── venv_clat/              # Shared Python virtual environment
├── revision_tracker.db     # Main GK database
├── math_tracker.db         # Math questions & sessions (360 questions)
└── assessment_tracker.db   # Assessment tracking
```

## CRITICAL: Database Locations (NEVER CREATE DUPLICATES)

All databases live at the **ROOT level** (`~/clat_preparation/`). Do NOT create databases in subdirectories.

| Database | Location | Purpose | Tables |
|----------|----------|---------|--------|
| `revision_tracker.db` | `~/clat_preparation/` | GK PDFs, topics, questions | pdfs, topics, questions, assessment_jobs |
| `math_tracker.db` | `~/clat_preparation/` | Math practice system | math_questions (360), math_sessions, math_answers, math_topic_settings |
| `assessment_tracker.db` | `~/clat_preparation/` | Assessment tracking | test_sessions, question_attempts |
| `finance_tracker.db` | `~/clat_preparation/` | Finance tracking | transactions, budgets |
| `health_tracker.db` | `~/clat_preparation/` | Health tracking | weight_log, exercise_log |

### Database Path Pattern (ALWAYS USE)
```python
# ✅ CORRECT - Root level database
db_path = Path(__file__).parent.parent / 'math_tracker.db'  # From server/
db_path = Path.home() / 'clat_preparation' / 'math_tracker.db'

# ❌ WRONG - Creates duplicate in subdirectory
db_path = Path(__file__).parent / 'math_tracker.db'  # From math_module/
db_path = Path(__file__).parent.parent / 'math_module' / 'math_tracker.db'
```

### Before Creating/Modifying Databases
1. **CHECK** if database already exists at root level
2. **NEVER** create databases in subdirectories (math_module/, server/, etc.)
3. **VERIFY** server uses the same path as scripts (e.g., populate_math_questions.py)

### Past Issues (December 2025)
- Math questions were generated to root `math_tracker.db` (360 questions)
- Server was configured to use `math_module/math_tracker.db` (old, 195 questions)
- Result: Users saw only 10-20 questions instead of expected amounts
- Fix: Always use root level path, deleted duplicate database

## Code Style & Standards

### Python
- Follow PEP 8 style guide
- Use type hints for function parameters and returns
- Docstrings for all public functions (Google style)
- Prefer `Path` from `pathlib` over string paths
- Always use `Path.home()` for user home directory (cross-machine compatibility)

### Database
- SQLite with explicit schemas
- Use migrations for schema changes
- Always use parameterized queries (prevent SQL injection)
- Connection pattern: context managers or explicit close()

### API Endpoints
- RESTful conventions
- JSON responses
- Proper HTTP status codes (200, 400, 404, 500)
- CORS disabled (local use only)

## Critical Deployment Rules

### Mac Mini Direct Access (ENABLED)
- ✅ CAN SSH directly to Mac Mini for deployments
- ✅ CAN restart server on Mac Mini
- ✅ CAN run git pull on Mac Mini
- ✅ CAN check server logs on Mac Mini

### Network Configuration
| Device | IP Address | Username | Notes |
|--------|------------|----------|-------|
| **MacBook Pro** | `192.168.18.3` | `arvind` | Development machine |
| **Mac Mini** | `192.168.18.4` | `arvindkumar` | Production server |

### Mac Mini Connection Details
- **IP Address:** 192.168.18.4
- **Hostname:** macmini.local (fallback, may not resolve)
- **SSH Config Alias:** `mac-mini` (preferred - use `ssh mac-mini`)
- **Username:** arvindkumar
- **Project Path:** ~/clat_preparation
- **Server Log:** /tmp/server.log
- **Production URL:** http://speedmathsgames.com

### SSH Config (already configured in ~/.ssh/config)
```
Host mac-mini
    HostName 192.168.18.4
    User arvindkumar
    IdentityFile ~/.ssh/id_rsa
```

### Deployment Workflow (Automated)
1. Develop on MacBook Pro (username: arvind)
2. Commit changes to Git
3. SSH to Mac Mini and pull changes
4. Restart server on Mac Mini
5. Verify deployment via API test

### Server Restart Commands (Mac Mini)
```bash
# SSH to Mac Mini (use configured alias)
ssh mac-mini

# Pull latest changes
cd ~/clat_preparation && git pull

# Restart server
pkill -f unified_server.py 2>/dev/null || true
sleep 2
nohup ~/clat_preparation/venv_clat/bin/python ~/clat_preparation/server/unified_server.py > /tmp/server.log 2>&1 &

# Verify
sleep 3 && curl -s http://localhost:8001/api/stats
```

### One-Line Deployment Command
```bash
# From MacBook Pro - commit, push, and deploy to Mac Mini
cd ~/clat_preparation && git add -A && git commit -m "Update" && git push && \
ssh mac-mini "cd ~/clat_preparation && git pull && pkill -f unified_server.py; sleep 2; nohup ~/clat_preparation/venv_clat/bin/python ~/clat_preparation/server/unified_server.py > /tmp/server.log 2>&1 &"
```

### Cross-Machine Compatibility
- MacBook Pro: `/Users/arvind/...`
- Mac Mini: `/Users/arvindkumar/...`
- Always use `Path.home()` or `os.path.expanduser('~')`
- Code includes automatic path correction in `unified_server.py`

## Key Workflows

### TopRankers Daily Automation
```bash
cd ~/clat_preparation/toprankers
source ~/.zshrc  # Loads ANTHROPIC_API_KEY
./automate_html.sh https://www.toprankers.com/current-affairs-DD-MONTH-YYYY
```
**Output:**
- PDF → ~/saanvi/Legaledgedailygk/current_affairs_YYYY_month_DD.pdf
- Anki cards → Imported to CLAT GK decks

### Start Development Server
```bash
cd ~/clat_preparation
source venv_clat/bin/activate
python server/unified_server.py
# Server: http://localhost:8001
```

### Chunk Large PDF
```bash
cd ~/clat_preparation
source venv_clat/bin/activate
python server/pdf_chunker.py <pdf_path>
# Creates: original_part1.pdf, original_part2.pdf, etc.
```

### Create Assessment (Flashcards)
- Use dashboard: http://localhost:8001/comprehensive_dashboard.html
- Click "Create Assessment" button on any PDF
- Background processing with real-time progress
- Processes 2-3 topics at a time for continuous feedback

## Database Schema Highlights

### revision_tracker.db
- **pdfs** - All PDF metadata
- **pdf_chunks** - Chunked PDF parts (when original >20 pages)
- **topics** - Extracted topics from PDFs

### assessment_tracker.db
- **assessment_jobs** - Background job tracking
- **processed_topics** - Deduplicated topics (SHA256 hash)
- **test_sessions** - User test attempts
- **question_attempts** - Individual Q&A tracking

## Security & API Keys

### Environment Variables
```bash
# API key stored in ~/.zshrc
export ANTHROPIC_API_KEY='sk-ant-...'
```

### Never Commit
- `.env` files
- `*.db` files (databases)
- API keys or secrets
- Virtual environment folders

### AnkiConnect
- Port: 8765 (local only)
- Must be running for card import
- Code: 2055492159

## Common Patterns

### PDF Path Resolution
```python
from pathlib import Path

# ✅ Correct - works on both machines
pdf_path = Path.home() / "saanvi" / "Legaledgedailygk" / filename

# ❌ Wrong - hardcoded username
pdf_path = Path("/Users/arvind/saanvi/...")
```

### Database Connection
```python
import sqlite3

# ✅ Correct - with context manager
with sqlite3.connect(db_path) as conn:
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM pdfs")
    # Auto-commits and closes
```

### API Error Handling
```python
@app.route('/api/endpoint')
def endpoint():
    try:
        # logic here
        return jsonify({'success': True, 'data': result}), 200
    except Exception as e:
        return jsonify({'error': str(e)}), 500
```

## Assessment Creation System

### Topic-Level Batching
- Processes 2-3 topics at a time (not entire chunk)
- Provides progress updates every 10-15 seconds
- Prevents silent 60-90 second stalls
- Uses SHA256 hashing for duplicate detection

### Progress Tracking
- Real-time updates via `/api/assessment-progress/<job_id>`
- Frontend polls every 2 seconds
- Shows: current chunk, batch, topic titles, card count

## Testing Guidelines

### Before Deployment
1. Test on MacBook Pro first
2. Verify all API endpoints respond
3. Check database integrity
4. Test TopRankers automation
5. Verify PDF chunking works
6. Test assessment creation end-to-end

### Common Test Commands
```bash
# Test imports
python -c "import server.unified_server; print('✅ OK')"

# Test database
sqlite3 revision_tracker.db "SELECT COUNT(*) FROM pdfs;"

# Test TopRankers scripts
cd toprankers && python -c "import extract_html; print('✅ OK')"

# Test API server
curl http://localhost:8001/api/test
```

## Performance Considerations

### Large PDFs
- Chunk if >20 pages (prevents OOM)
- Process 8-10 pages per chunk
- Parallel processing possible but not implemented

### API Rate Limits
- Anthropic API: Standard rate limits apply
- Add delays between batch requests if needed
- Current: No explicit rate limiting

### Database
- SQLite is fine for single-user, local use
- Regular VACUUM for optimization
- Indexes on frequently queried columns

## Troubleshooting

### Server Won't Start
- Check if port 8001 is in use: `lsof -ti:8001`
- Kill existing: `lsof -ti:8001 | xargs kill -9`

### Anki Import Fails
1. Ensure Anki is running
2. Check AnkiConnect installed (code: 2055492159)
3. Close any dialog boxes in Anki

### API Key Issues
```bash
# Check if key is set
echo $ANTHROPIC_API_KEY

# Reload environment
source ~/.zshrc
```

### TopRankers Extraction Fails
- URL format: `https://www.toprankers.com/current-affairs-DD-MONTH-YYYY`
- Page might not be published yet (future dates)
- Check BeautifulSoup is installed

### iCloud Sync Issues (PDFs not appearing on Mac Mini)
The `~/saanvi/` folder is synced via iCloud. If new PDFs don't appear:
1. Check iCloud status: `brctl status` (look for `needs-sync-down`)
2. Force download: `brctl download ~/saanvi/LegalEdgeweeklyGK/`
3. Open Finder on Mac Mini and navigate to folder (triggers sync)
4. Check iCloud Drive storage isn't full
5. Wait 5-10 minutes for automatic sync

## AI-Specific Instructions

### When Editing Code
- Always read the entire file first
- Preserve existing patterns and style
- Add comments for complex logic
- Update docstrings if function signature changes
- Test changes mentally before suggesting

### When Asked About Architecture
- Reference PROJECT_HANDOFF.md for full details
- Explain two-machine deployment model
- Highlight cross-machine compatibility requirements

### When Debugging
- Check server logs: `/tmp/server.log`
- Look at database state: `sqlite3 *.db`
- Verify API keys are set
- Check file permissions

## Debugging & Execution Visibility Rules

When debugging or handling unexpected behavior:

- **Default to a debugging workflow, not speculative fixes.**
- Reason about runtime execution paths before modifying logic.
- If execution is unclear, instrument the code with temporary, structured logging.
- Prefer logs that expose:
  - Inputs
  - Intermediate state
  - Key decisions / branches
  - Outputs

### Debug Log Format
Debug logs should be:
- Clearly labeled (`[DEBUG STEP]`, `[DEBUG STATE]`, `[DEBUG DECISION]`, `[DEBUG RESULT]`)
- Structured where possible (objects, key-value pairs)
- Temporary unless explicitly requested otherwise

### Log Preservation Rules
- **Do NOT remove or weaken existing business-logic logs**
- Preserve meaningful logs and add debug instrumentation separately
- Remove debug logs after issue is resolved (unless user requests to keep)

### Workflow
1. **Understand first**: Read code and reason about execution path
2. **Instrument**: Add debug logs at key points
3. **Execute**: Run the code and collect output
4. **Analyze**: Use logs to identify root cause
5. **Fix**: Make targeted fix based on evidence
6. **Clean up**: Remove temporary debug logs

Assume the user is willing to run the code and share execution output.

## Recent Changes (December 2025)

### Project Consolidation
- Moved TopRankers scripts from `~/Desktop/anki_automation/` to `~/clat_preparation/toprankers/`
- Created shared virtual environment (`venv_clat`)
- All code now in single project folder
- Old location deprecated

### PDF Spacing Feature
- Attempted to add spacing for iPad annotation
- Feature abandoned - lost formatting
- All `*_s.pdf` files removed
- Original PDFs unchanged

## Documentation Files
- `PROJECT_HANDOFF.md` - Complete system documentation (9,500+ lines)
- `CONSOLIDATION_SUMMARY.md` - Recent migration details
- `toprankers/README.md` - TopRankers automation guide
- `ARCHITECTURE.md` - System architecture details

## Critical Deployment Lessons (December 2025)

### 1. Virtual Environment Path Issue
**Problem:** When `venv_clat/` is synced from MacBook Pro to Mac Mini via git, the shebang paths break:
```
bad interpreter: /Users/arvind/clat_preparation/venv_clat/bin/python3: no such file or directory
```
**Solution:** ALWAYS recreate venv on Mac Mini after deployment:
```bash
cd ~/clat_preparation
rm -rf venv_clat
python3 -m venv venv_clat
~/clat_preparation/venv_clat/bin/pip install anthropic requests PyPDF2 PyMuPDF python-dotenv beautifulsoup4 reportlab Pillow google-auth google-auth-oauthlib google-auth-httplib2
```

### 2. API_BASE in Frontend Files
**Problem:** Hardcoded `const API_BASE = 'http://localhost:8001'` breaks when accessed via `speedmathsgames.com`
**Solution:** ALWAYS use dynamic origin:
```javascript
const API_BASE = window.location.origin;  // ✅ Correct
const API_BASE = 'http://localhost:8001'; // ❌ Wrong - breaks in production
```
**Files to check:** `assessment-progress.html`, `pdf-chunker.html`, any new dashboard files

### 3. Database Paths Must Be Relative
**Problem:** Absolute paths like `/Users/arvind/saanvi/file.pdf` break on Mac Mini (`/Users/arvindkumar/`)
**Solution:** Store paths as relative in database: `saanvi/Legaledgedailygk/file.pdf`
- Use `pdf_scanner.path_to_relative()` when saving
- Use `pdf_scanner.relative_to_absolute()` when reading
- Run `scripts/fix_database_paths.py` if absolute paths sneak in

### 4. Required Python Packages for PDF Features
For "Create PDF from URL" feature to work, Mac Mini needs:
- `reportlab` - PDF generation
- `Pillow` - Image handling (required by reportlab)
- `beautifulsoup4` - HTML parsing

### 5. Server Restart Command (Mac Mini)
```bash
pkill -f unified_server.py 2>/dev/null || true
sleep 2
nohup ~/clat_preparation/venv_clat/bin/python ~/clat_preparation/server/unified_server.py > /tmp/server.log 2>&1 &
```

## GK Dashboard Business Rules (comprehensive_dashboard.html)

### CRITICAL: PDF Processing Workflow

**This is the most complex page in the system. Always refer to these rules when modifying.**

#### Page Threshold Rule
- **≤13 pages**: Small PDF - does NOT need chunking
- **>13 pages**: Large PDF - MUST be chunked before processing

#### Button States & Workflow

| PDF Size | Chunk Button | Create Assessment | Test | Revised | Status |
|----------|--------------|-------------------|------|---------|--------|
| >13 pages (not chunked) | **ACTIVE** | Disabled | Disabled | Disabled | Not Processed |
| >13 pages (after chunking) | Removed from list | - | - | - | Moved to "Large Files" |
| ≤13 pages (not processed) | Greyed/Disabled | **ACTIVE** | Disabled | Disabled | Not Processed |
| ≤13 pages (processed) | Greyed | Greyed | **ACTIVE** | Depends | Processed |
| Any (revised) | - | - | - | **GREEN ✓** | Processed |

#### Detailed Rules

1. **Large PDFs (>13 pages)**: 
   - Displayed in **RED font** to indicate action needed
   - ONLY the Chunk button is active
   - All other buttons (Create Assessment, Test, Revised) are DISABLED
   - Status shows "Not Processed"

2. **Chunking Process**:
   - Click Chunk → Splits into smaller PDFs (≤13 pages each)
   - Original large PDF is REMOVED from main list
   - Original moves to "Large Files" folder view only
   - Chunked parts appear in main list (e.g., `filename_part1.pdf`, `filename_part2.pdf`)

3. **Small PDFs (≤13 pages)**:
   - Chunk button is GREYED (not needed)
   - Create Assessment button is ACTIVE
   - Status shows "Not Processed" until assessment is created

4. **After Create Assessment**:
   - Questions are generated via Claude AI
   - Cards are sent to Anki
   - Status changes to "Processed"
   - Create Assessment button becomes GREYED
   - Test button becomes ACTIVE

5. **Revised Button**:
   - Shows GREEN checkmark (✓) only when user has:
     - Opened the PDF
     - Modified/annotated it
     - Saved the changes
   - Otherwise remains unchecked

6. **Columns Explained**:
   - **TOPICS**: Number of topics extracted from PDF
   - **REVISIONS**: Number of times PDF has been revised/modified
   - **TEST ATTEMPTS**: Number of times questions from this PDF were attempted
   - **LAST REVISED**: When the PDF was last modified
   - **STATUS**: "Not Processed" or "Processed"
   - **Details**: Shows modification history and timestamps

#### Visual Indicators
- **Red font**: PDF >13 pages, needs chunking
- **Green Revised button**: PDF has been revised
- **Greyed button**: Action not available/not needed
- **Active button**: Action available

#### State Transitions
```
Large PDF (>13 pages)
    │
    ▼ [Click Chunk]
Chunked PDFs (≤13 pages each) + Original moved to "Large Files"
    │
    ▼ [Click Create Assessment]
Processed PDF (cards in Anki)
    │
    ▼ [User revises PDF]
Revised PDF (green checkmark)
```

## Multi-User Family System (December 2025)

### User Roles (defined in server/user_roles.py)
| Email | User ID | Name | Role | Permissions |
|-------|---------|------|------|-------------|
| `k12arvind@gmail.com` | arvind | Arvind | admin | View all, edit all settings |
| `deepay2019@gmail.com` | deepa | Deepa | parent | View all, edit all settings |
| `20saanvi12@gmail.com` | saanvi | Saanvi | child | Own data only |
| `20navya12@gmail.com` | navya | Navya | child | Own data only |

### Admin/Parent Features
- **Family Dashboard:** `/family_dashboard.html` - Overview of all children's data
- **Admin API Endpoints:**
  - `GET /api/admin/family` - List all family members
  - `GET /api/admin/children` - List children with summary stats
  - `GET /api/admin/diary/all` - All children's diary entries
  - `GET /api/admin/diary/{user_id}` - Specific child's diary
  - `GET /api/admin/math/all` - All children's math performance
  - `GET /api/admin/settings/{user_id}` - Get child's math settings
  - `POST /api/admin/settings/{user_id}` - Update child's math settings

### Per-User Data Isolation
- All user-specific data is keyed by `user_id`
- Diary entries, math scores, assessments are per-user
- Math topic settings (enabled/disabled, difficulty) are per-user
- Children can only see their own data

### Authentication Flow
1. User logs in via Google OAuth
2. Email is matched to `USER_ROLES` in `server/user_roles.py`
3. Role determines which pages/features are visible
4. Dynamic user_id flows through all API calls

## Resilient Auto-Recovery System (December 2025)

### Overview
The system is designed to automatically recover from power cuts without manual intervention.

### Components

| Component | File | Purpose |
|-----------|------|---------|
| **Health Monitor** | `scripts/health_monitor.sh` | Runs every 2 minutes, checks server & tunnel health |
| **Cloudflared Starter** | `scripts/start_cloudflared.sh` | Waits for network before starting tunnel |
| **Server Starter** | `scripts/start_server.sh` | Loads API key from .zshrc, ensures venv exists |
| **Deploy Script** | `scripts/deploy_resilient_services.sh` | One-command setup of all LaunchAgents |

### LaunchAgents (Mac Mini ~/Library/LaunchAgents/)

| Plist | Service | Features |
|-------|---------|----------|
| `com.clatprep.server.plist` | Python Server | RunAtLoad, KeepAlive, auto-restart |
| `com.cloudflare.tunnel.plist` | Cloudflared | RunAtLoad, network-aware startup |
| `com.clatprep.healthmonitor.plist` | Health Check | Runs every 2 minutes |

### Auto-Recovery Flow (After Power Cut)

```
Power Restored
    ↓
Mac Mini auto-boots (System Settings > Energy Saver enabled)
    ↓
LaunchAgents start automatically
    ↓
start_server.sh → waits for network → starts Python server
    ↓
start_cloudflared.sh → waits for network → starts tunnel
    ↓
health_monitor.sh (every 2 min) → checks & restarts if needed
```

### Logs Location (Mac Mini)

| Log | Path |
|-----|------|
| Server | `~/clat_preparation/logs/server.log` |
| Server Errors | `~/clat_preparation/logs/server_error.log` |
| Cloudflared | `~/clat_preparation/logs/cloudflared.log` |
| Cloudflared Errors | `~/clat_preparation/logs/cloudflared_error.log` |
| Health Monitor | `~/clat_preparation/logs/health_monitor.log` |
| Startup Logs | `~/clat_preparation/logs/*_startup.log` |

### Redeploy Resilience System
```bash
ssh mac-mini "cd ~/clat_preparation && git pull && bash scripts/deploy_resilient_services.sh"
```

### Verify Services
```bash
ssh mac-mini "launchctl list | grep -E 'clatprep|cloudflare'"
ssh mac-mini "curl -s http://localhost:8001/api/stats"
curl -s https://speedmathsgames.com
```

### Important: Mac Mini Auto-Boot
Ensure this setting is enabled on Mac Mini:
**System Settings > Energy Saver > "Start up automatically after a power failure"**

This is already enabled on the current Mac Mini (autorestart=1).

## When in Doubt
1. Read PROJECT_HANDOFF.md first
2. Check existing code patterns
3. Test on MacBook Pro before suggesting Mac Mini changes
4. Ask user for clarification on ambiguous requirements
5. Preserve existing functionality unless explicitly asked to change
